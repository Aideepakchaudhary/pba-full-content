---
title: Parachains Architecture - Availbility Deep Dive
description: Polkadot Parachains for Web3 engineers
duration: 1 hour
instructors: ["Bernhard Schuster, Robert Klotzner"]
teaching-assistants: ["Dan Shields"]
---

# Achieving Availability

<image src="../../../assets/img/5-Polkadot/5.4/bs_impl_arch.svg" style="height: 600px" >

---

## Lecture Goals

- Parachain consensus <!-- .element: class="fragment" -->

---

## Path of a parachain - birds eye

- Backing <!-- .element: class="fragment" -->
- Availability <!-- .element: class="fragment" -->
- Approval <!-- .element: class="fragment" -->
- (Disputes) <!-- .element: class="fragment" -->

---

<image src="../../../assets/img/5-Polkadot/5.4/bs_block_prod.svg" style="height: 600px">


---

## Revisit

- What does availability mean?

- Why do we need availability?

---

- Why not to just distribute the PoV?

  - How large is a PoV?

    - Network Bandwidth
    - Storage on chain

Notes:

- Allow retrieval of the PoV from the block producer
- Availability is when we can reconstruct the PoV
- Availability is when we (a validator) have retrieved the chunk for our index, by extension we can then query a sufficient number of validators to recover the original data
- Every validator queries the respective validator index for their chunk, given we know by means of bitfield distribution they have their chunk
-

## Compressed representation: Bitfields

- Gossiped availability bitfields, the candidates that are available from the point of view of _one validator_ in the backing group - number of bits equiv. to the number of `AvailabilityCore`s - submitted on-chain

<image src="../../../assets/img/5-Polkadot/5.4/5.4-availability-gossip.svg" style="height: 500px">

---

- Accumulation of validators that voted on-chain: `CandidatePendingAvailability.availability_votes` - each bit determines if a validator voted for a particular candidate's availability record to be present - number of bits is equiv. to the number of `Validator`s in the backing group

---

## Other Bitfields (not to be confused)

- backing group validator indices bitfields as part of the backing entries
- ...

---

## Availability Core

- Concept of parachain/thread processing units
- speculative scheduling

---


## How a block becomes available

---

<image src="../../../assets/img/5-Polkadot/5.4/5.4-relay-block-construction-I.svg" style="height: 600px">

---

<image src="../../../assets/img/5-Polkadot/5.4/5.4-relay-block-construction-II.svg" style="height: 600px">

---

## polkadot.js

<image src="../../../assets/img/5-Polkadot/5.4/bs_polkadot_js_bitfields.png" style="height: 600px">

- part of the `InherentData.enter`

---

<image src="../../../assets/img/5-Polkadot/5.4/bs_polkadot_js_inclusion.png" style="height: 600px">

---

## Erasure Encoding - An Outline

Goals:

- Allow to reconstruct the original data from `k` out of `n` chunks, losing `t` chunks at most.

---

## Proceedings

<image src="../../../assets/img/5-Polkadot/5.4/5.4-erasure-encoding-abstract.svg" style="height: 600px">

---

- Galois (Extension) Field (static, shared) $\mathbb{F}/p$
- Generator Polynomial (static, shared)

---

$p_x(a) = \sum^k_{i=1} x_i a^{i-1}$

$ C(x) = (p_x(a_1),.. p_x(a_n))$

$ C(x): \mathbb{F}^k -> \mathbb{F}^n$

---

$A = \begin{bmatrix}1 & \cdots & 1 & \cdots & 1\\\\ a_1 & \cdots & a_k & \cdots & a_n\\\\ a_1^2 & \cdots & a_k^2 & \cdots & a_n^2\\\\ \vdots & & \vdots & & \vdots\\\\ a_1^{k-1} & \cdots & a_k^{k-1} & \cdots & a_n^{k-1}\end{bmatrix}$

---

Notes:

- $C(x)$ is a linear mapping
- linear code
- $A$ is the generator matrix
- non-systematic
- DFFT if $a_i$ = $\alpha_i$

## Decoding

- Matrix inversion

---

Notes:

- DIFFT (only if $\alpha$ is a primitve root of $\mathbb{F}/p$ where $p$ prime and no errors in the chunks received)

---

## Malicious Actors

- Altered chunk data?
- Would cause a PoV / PVF run to fail!

---

Solution: Supply a merkle proof with each chunk

---

Notes:

- Use syndromes, more complexity in the decoder, limited error correction and ability

## Erasure Encoding - Reality

- Matrix inversion / multiplication too slow $O(n^3)$

---

- \mathbb{F}_2^16 (an extension field without primitive roots)
- `u16` as extension field element representation
- no more multiplcative FFT possible

Polkadot Implementation: Novel Polynomial Basis (paper by Sian-Jheng Lin et. al.): <https://github.com/paritytech/reed-solomon-novelpoly>

---

Notes:

- binary representation allows for fast field operations
- not a multiplicative ring anymore
- ...
